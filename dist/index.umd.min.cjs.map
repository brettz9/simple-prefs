{"version":3,"file":"index.umd.min.cjs","sources":["../src/simple-prefs.js"],"sourcesContent":["/**\n * @typedef {{[key: string]: JSONValue}} Defaults\n */\n\n/**\n * @typedef {null|boolean|number|string} JSONPrimitive\n */\n/**\n * @typedef {JSONValue[]} JSONArray\n */\n/**\n * @typedef {JSONPrimitive | JSONArray | {\n *   [key in string]: JSONValue\n * }} JSONValue\n */\n\n/**\n * Preferences storage.\n */\nexport class SimplePrefs {\n  /**\n   * @param {object} cfg\n   * @param {string} [cfg.namespace] Avoid clashes with other apps\n   * @param {Defaults} [cfg.defaults]\n   * @param {SimplePrefsDefaults} [cfg.prefDefaults]\n   */\n  constructor (cfg) {\n    this.configurePrefs(cfg);\n\n    /** @type {((e: StorageEvent) => void)[]} */\n    this.listeners = [];\n  }\n  /**\n   * @param {object} cfg\n   * @param {string} [cfg.namespace] Avoid clashes with other apps\n   * @param {Defaults} [cfg.defaults]\n   * @param {SimplePrefsDefaults} [cfg.prefDefaults]\n   * @returns {void}\n   */\n  configurePrefs ({\n    namespace, defaults, prefDefaults = simplePrefsDefaults(defaults)\n  }) {\n    this.namespace = namespace ?? '';\n    this.prefDefaults = prefDefaults;\n  }\n  /**\n   * Get parsed preference value; returns `Promise` in anticipation\n   * of https://domenic.github.io/async-local-storage/ .\n   * @callback GetPref\n   * @param {string} key Preference key (for Chrome-Compatibility, only `\\w+`)\n   * @returns {Promise<JSONValue>} Resolves to the parsed\n   *   value (defaulting if necessary)\n   */\n\n  /** @type {GetPref} */\n  async getPref (key) {\n    const result = localStorage.getItem(this.namespace + key);\n    return result === null\n      ? await /** @type {SimplePrefsDefaults} */ (\n        this.prefDefaults\n      ).getPrefDefault(key)\n      : JSON.parse(result);\n  }\n  /**\n   * Set a stringifiable preference value; returns `Promise` in anticipation\n   *   of https://domenic.github.io/async-local-storage/ .\n   * @callback SetPref\n   * @param {string} key Preference key (for Chrome-Compatibility, only `\\w+`)\n   * @param {JSONValue} val Stringifiable value\n   * @returns {Promise<void>} Resolves after setting the item (Not currently\n   *    in use)\n   */\n\n  /** @type {SetPref} */\n  async setPref (key, val) {\n    return await localStorage.setItem(\n      this.namespace + key, JSON.stringify(val)\n    );\n  }\n\n  /**\n  * @typedef {object} GetPrefSetPref\n  * @property {GetPref} getPref\n  * @property {SetPref} setPref\n  */\n\n  /**\n   * Convenience utility to return two main methods `getPref` and\n   *   `setPref` bound to the current object.\n   * @returns {GetPrefSetPref}\n   */\n  bind () {\n    return {\n      getPref: this.getPref.bind(this),\n      setPref: this.setPref.bind(this)\n    };\n  }\n\n  /**\n  * @callback PreferenceCallback\n  * @param {StorageEvent} e\n  * @returns {void}\n  */\n\n  /* eslint-disable promise/prefer-await-to-callbacks -- Repeating event */\n  /**\n  * @param {string|PreferenceCallback|undefined} key\n  * @param {PreferenceCallback} cb\n  * @returns {PreferenceCallback}\n  */\n  listen (key, cb) {\n    if (typeof key === 'function') {\n      cb = key;\n      key = undefined;\n    }\n\n    /**\n     * @param {StorageEvent} e\n     */\n    const listener = (e) => {\n      if (e.key === null) { // `null` for clear browser action or user `clear()`\n        if (key === undefined) { // Only trigger when no key supplied\n          return;\n        }\n      } else {\n        if (!e.key.startsWith(/** @type {string} */ (this.namespace))) {\n          return;\n        }\n        if (key !== undefined && !e.key.startsWith(\n          /** @type {string} */ (this.namespace) + key\n        )) {\n          return;\n        }\n      }\n\n      cb(e);\n    };\n\n    globalThis.addEventListener('storage', listener);\n\n    this.listeners.push(listener);\n\n    return listener;\n  }\n\n  /**\n   * @param {EventListener} listener\n   * @returns {void}\n   */\n  unlisten (listener) {\n    if (listener) {\n      for (let i = 0; i < this.listeners.length; i++) {\n        if (listener === this.listeners[i]) {\n          this.listeners.splice(i, 1);\n          globalThis.removeEventListener('storage', listener);\n          return;\n        }\n      }\n    }\n    this.listeners.forEach((listenerItem) => {\n      globalThis.removeEventListener('storage', listenerItem);\n    });\n  }\n  /* eslint-enable promise/prefer-await-to-callbacks -- Repeating event */\n}\n\n/**\n * Defaults for SimplePrefs.\n */\nexport class SimplePrefsDefaults {\n  /**\n   *\n   * @param {{defaults: Defaults}} defaults\n   */\n  constructor ({defaults}) {\n    this.defaults = defaults;\n  }\n  /**\n   * Get parsed default value for a preference.\n   * @param {string} key Preference key\n   * @returns {Promise<JSONValue>}\n   */\n  async getPrefDefault (key) {\n    return await this.defaults[key] ?? null;\n  }\n\n  /**\n   * Set parsed default value for a preference.\n   * @param {string} key Preference key\n   * @param {JSONValue} value\n   * @returns {Promise<JSONValue>} The old value\n   */\n  async setPrefDefault (key, value) {\n    const oldValue = this.defaults[key] ?? null;\n    this.defaults[key] = value;\n    return await oldValue;\n  }\n}\n\n/**\n * Simplified factory for `SimplePrefsDefaults`\n * @param {Defaults} [defaults]\n * @returns {SimplePrefsDefaults}\n */\nexport function simplePrefsDefaults (defaults = {}) {\n  return new SimplePrefsDefaults({defaults});\n}\n"],"names":["_await","value","then","direct","Promise","resolve","_call","body","result","e","reject","SimplePrefsDefaults","constructor","defaults","this","getPrefDefault","key","_this3","_this3$defaults$key","setPrefDefault","_this4","oldValue","simplePrefsDefaults","cfg","configurePrefs","listeners","namespace","prefDefaults","getPref","_this","localStorage","getItem","JSON","parse","setPref","val","_this2","setItem","stringify","bind","listen","cb","undefined","listener","startsWith","globalThis","addEventListener","push","unlisten","i","length","splice","removeEventListener","forEach","listenerItem"],"mappings":"kPAoFO,SAAAA,EAAgBC,EAAOC,EAAMC,GACnC,OAAIA,EACID,EAAOA,EAAKD,GAASA,GAExBA,GAAUA,EAAMC,OACpBD,EAAQG,QAAQC,QAAQJ,IAElBC,EAAOD,EAAMC,KAAKA,GAAQD,EAClC,CAmbO,SAAAK,EAAeC,EAAML,EAAMC,GAIjC,IACC,IAAIK,EAASJ,QAAQC,QAAQE,KAC7B,OAAOL,EAAOM,EAAON,KAAKA,GAAQM,CACnC,CAAE,MAAOC,GACR,OAAOL,QAAQM,OAAOD,EACvB,CACD,CAhXO,MAAME,EAKXC,WAAAA,EAAaC,SAACA,IACZC,KAAKD,SAAWA,CAClB,CAMME,cAAAA,CAAgBC,GAAG,MAAAC,EACVH,KAAI,OAAAR,EAAA,WADQ,OAAAN,EACZiB,EAAKJ,SAASG,GAAI,SAAAE,GAA/B,OAAOA,GAA4B,IAAK,EAC1C,EAAC,CAQKC,cAAAA,CAAgBH,EAAKf,GAAK,MAAAmB,EACbN,KAAI,OAAAR,EAAA,WAArB,MAAMe,EAAWD,EAAKP,SAASG,IAAQ,KACZ,OAA3BI,EAAKP,SAASG,GAAOf,EAAMD,EACdqB,EACf,EAAC,EAQI,SAASC,EAAqBT,EAAW,IAC9C,OAAO,IAAIF,EAAoB,CAACE,YAClC,eA3LO,MAOLD,WAAAA,CAAaW,GACXT,KAAKU,eAAeD,GAGpBT,KAAKW,UAAY,EACnB,CAQAD,cAAAA,EAAgBE,UACdA,EAASb,SAAEA,EAAQc,aAAEA,EAAeL,EAAoBT,KAExDC,KAAKY,UAAYA,GAAa,GAC9BZ,KAAKa,aAAeA,CACtB,CAWMC,OAAAA,CAASZ,GAAG,MAAAa,EACoBf,KAAI,OAAAR,EAAA,WAAxC,MAAME,EAASsB,aAAaC,QAAQF,EAAKH,UAAYV,GAAK,OAAAhB,EAAAA,EACxC,OAAXQ,EAEHqB,EAAKF,aACLZ,eAAeC,GACfgB,KAAKC,MAAMzB,QAAO,IAJJ,OAAXA,IAKT,EAAC,CAYK0B,OAAAA,CAASlB,EAAKmB,GAAG,MAAAC,EAEnBtB,KAAI,OAAAR,EAAA,WAFiB,OAAAN,EACV8B,aAAaO,QACxBD,EAAKV,UAAYV,EAAKgB,KAAKM,UAAUH,IAEzC,EAAC,CAaDI,IAAAA,GACE,MAAO,CACLX,QAASd,KAAKc,QAAQW,KAAKzB,MAC3BoB,QAASpB,KAAKoB,QAAQK,KAAKzB,MAE/B,CAcA0B,MAAAA,CAAQxB,EAAKyB,GACQ,mBAARzB,IACTyB,EAAKzB,EACLA,OAAM0B,GAMR,MAAMC,EAAYlC,IAChB,GAAc,OAAVA,EAAEO,KACJ,QAAY0B,IAAR1B,EACF,WAEG,CACL,IAAKP,EAAEO,IAAI4B,WAAkC9B,KAAKY,WAChD,OAEF,QAAYgB,IAAR1B,IAAsBP,EAAEO,IAAI4B,WACP9B,KAAKY,UAAaV,GAEzC,MAEJ,CAEAyB,EAAGhC,IAOL,OAJAoC,WAAWC,iBAAiB,UAAWH,GAEvC7B,KAAKW,UAAUsB,KAAKJ,GAEbA,CACT,CAMAK,QAAAA,CAAUL,GACR,GAAIA,EACF,IAAK,IAAIM,EAAI,EAAGA,EAAInC,KAAKW,UAAUyB,OAAQD,IACzC,GAAIN,IAAa7B,KAAKW,UAAUwB,GAG9B,OAFAnC,KAAKW,UAAU0B,OAAOF,EAAG,QACzBJ,WAAWO,oBAAoB,UAAWT,GAKhD7B,KAAKW,UAAU4B,QAASC,IACtBT,WAAWO,oBAAoB,UAAWE,IAE9C"}